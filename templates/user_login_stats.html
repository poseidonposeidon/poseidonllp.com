<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <link href="/static/img/favicon.ico" rel="shortcut icon"/>
    <link rel="stylesheet" type="text/css" href="/static/css/main.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>使用者統計與查詢日誌 (Fetch API)</title> <!-- 可以更新一下標題 -->
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
            color: #333;
        }
        h1, h2 { /* 將 h2 也加入樣式 */
            color: #333;
            text-align: center;
        }
        table {
            width: 80%; /* 稍微加寬一點以容納更多內容或兩個表格 */
            margin: 20px auto;
            border-collapse: collapse;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
            background-color: #fff;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        th {
            background-color: #007bff;
            color: white;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        /* 確保 hover 效果應用於動態添加的行 */
        #statsTableBody tr:hover, #stockLogsTableBody tr:hover {
            background-color: #f1f1f1;
        }
        .loading-message, .error-message, .no-data {
            text-align: center;
            padding: 20px;
            font-style: italic;
        }
        .error-message {
            color: red;
        }
    </style>
</head>
<body>
<h1>使用者登入次數統計</h1>

<div id="loadingUserStats" class="loading-message">正在載入使用者登入統計...</div>
<div id="errorUserStats" class="error-message" style="display:none;"></div>

<table id="statsTable" style="display:none;">
    <thead>
    <tr>
        <th>使用者名稱 (Username)</th>
        <th>登入次數 (Login Count)</th>
    </tr>
    </thead>
    <tbody id="statsTableBody">
    <!-- 使用者登入資料將由 JavaScript 動態填入 -->
    </tbody>
</table>
<p id="noDataUserStats" class="no-data" style="display:none;">目前沒有使用者登入統計資料可顯示。</p>

<hr style="margin: 40px auto; width: 80%;"> <!-- 分隔線 -->

<h2>股票查詢日誌</h2> <!-- 新增標題 -->

<div id="loadingStockLogs" class="loading-message">正在載入股票查詢日誌...</div>
<div id="errorStockLogs" class="error-message" style="display:none;"></div>

<table id="stockLogsTable" style="display:none;">
    <thead>
    <tr>
        <th>使用者名稱</th>
        <th>市場區域</th>
        <th>查詢內容</th>
        <th>查詢時間</th>
    </tr>
    </thead>
    <tbody id="stockLogsTableBody">
    <!-- 股票查詢日誌資料將由 JavaScript 動態填入 -->
    </tbody>
</table>
<p id="noDataStockLogs" class="no-data" style="display:none;">目前沒有股票查詢日誌可顯示。</p>


<p style="text-align:center; margin-top: 20px;">
    <a href="/">返回首頁</a>
</p>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- 使用者登入統計相關元素 ---
        const statsTable = document.getElementById('statsTable');
        const statsTableBody = document.getElementById('statsTableBody');
        const loadingUserStatsDiv = document.getElementById('loadingUserStats');
        const errorUserStatsDiv = document.getElementById('errorUserStats');
        const noDataUserStatsDiv = document.getElementById('noDataUserStats');
        const userStatsApiUrl = 'https://api.poseidonllp.com/api/user_login_stats'; // 使用相對路徑

        // --- 股票查詢日誌相關元素 ---
        const stockLogsTable = document.getElementById('stockLogsTable');
        const stockLogsTableBody = document.getElementById('stockLogsTableBody');
        const loadingStockLogsDiv = document.getElementById('loadingStockLogs');
        const errorStockLogsDiv = document.getElementById('errorStockLogs');
        const noDataStockLogsDiv = document.getElementById('noDataStockLogs');
        const stockLogsApiUrl = 'https://api.poseidonllp.com/api/stock_query_logs'; // 使用相對路徑

        // 函數：獲取並顯示使用者登入統計
        function fetchUserLoginStats() {
            fetch(userStatsApiUrl)
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(errData => {
                            throw new Error(errData.error || `伺服器錯誤 (使用者統計): ${response.status}`);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    loadingUserStatsDiv.style.display = 'none';
                    if (data && data.users_stats && data.users_stats.length > 0) {
                        statsTable.style.display = 'table';
                        data.users_stats.forEach(stat => {
                            const row = statsTableBody.insertRow();
                            row.insertCell(0).textContent = stat.username;
                            row.insertCell(1).textContent = stat.login_count;
                        });
                    } else {
                        noDataUserStatsDiv.style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('獲取使用者統計資料時發生錯誤:', error);
                    loadingUserStatsDiv.style.display = 'none';
                    errorUserStatsDiv.textContent = '無法載入使用者統計資料：' + error.message;
                    errorUserStatsDiv.style.display = 'block';
                });
        }

        // 函數：獲取並顯示股票查詢日誌
        function fetchStockQueryLogs() {
            fetch(stockLogsApiUrl)
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(errData => {
                            throw new Error(errData.error || `伺服器錯誤 (查詢日誌): ${response.status}`);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    loadingStockLogsDiv.style.display = 'none';
                    if (data && data.stock_logs && data.stock_logs.length > 0) {
                        stockLogsTable.style.display = 'table';
                        data.stock_logs.forEach(log => {
                            const row = stockLogsTableBody.insertRow();
                            row.insertCell(0).textContent = log.username;
                            row.insertCell(1).textContent = log.market_area;
                            row.insertCell(2).textContent = log.query_text;
                            // 格式化時間戳 (可選，如果 API 回傳的是 ISO 字串)
                            const date = new Date(log.timestamp);
                            row.insertCell(3).textContent = date.toLocaleString('zh-TW'); // 或者您喜歡的其他格式
                        });
                    } else {
                        noDataStockLogsDiv.style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('獲取股票查詢日誌時發生錯誤:', error);
                    loadingStockLogsDiv.style.display = 'none';
                    errorStockLogsDiv.textContent = '無法載入股票查詢日誌：' + error.message;
                    errorStockLogsDiv.style.display = 'block';
                });
        }

        // 頁面載入完成後，分別獲取兩部分資料
        fetchUserLoginStats();
        fetchStockQueryLogs();
    });
</script>
</body>
</html>